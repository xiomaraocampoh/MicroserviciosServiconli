<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Serviconli - Gestión de Tareas Médicas</title>
  <link rel="stylesheet" href="/frontend-app/css/style.css" />
  <style>
    body { font-family: Arial, sans-serif; margin: 0; background: #f7f9fb; }
    .header { display: flex; justify-content: space-between; align-items: center; background: #01c38d; color: white; padding: 10px 20px; }
    .controls { display: flex; justify-content: space-between; align-items: center; padding: 10px; }
    .filters { display: flex; gap: 15px; }
    .filter-group { display: flex; flex-direction: column; }
    .kanban-board { display: flex; gap: 10px; padding: 10px; overflow-x: auto; }
    .kanban-column { background: white; border-radius: 8px; padding: 10px; min-width: 250px; }
    .task-card { background: #f1f1f1; padding: 8px; margin-bottom: 8px; border-radius: 6px; }
    .task-actions { display: flex; justify-content: space-between; }
    .btn { border: none; border-radius: 5px; padding: 6px 10px; cursor: pointer; }
    .btn-success { background: #28a745; color: white; }
    .btn-danger { background: #dc3545; color: white; }
    .notification { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); padding: 10px 20px; border-radius: 6px; color: white; display: none; }
    .notification.show { display: block; }
    .modal { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.6); display: flex; justify-content: center; align-items: center; }
    .modal.hidden { display: none; }
    .modal-content { background: white; padding: 20px; border-radius: 10px; width: 90%; max-width: 550px; max-height: 90%; overflow-y: auto; }
    .form-group { display: flex; flex-direction: column; margin-bottom: 10px; }
    .form-input { padding: 6px; border-radius: 5px; border: 1px solid #ccc; }
    .form-buttons { display: flex; justify-content: flex-end; gap: 10px; }
  </style>
</head>
<body>
<div class="header">
  <div>Central de Citas - Serviconli</div>
  <div>
    <button class="btn btn-primary" onclick="showCreateForm()">➕ Nueva tarea</button>
    <button class="btn btn-secondary" onclick="logout()">🔒 Cerrar sesión</button>
  </div>
</div>

<div class="controls">
  <div class="filters">
    <div class="filter-group">
      <label>Estado</label>
      <select id="filterStatus" class="form-input">
        <option value="">Todos</option>
        <option value="PENDIENTE">Pendiente</option>
        <option value="EN_PROGRESO">En Progreso</option>
        <option value="CITA_CONFIRMADA">Cita Confirmada</option>
        <option value="ENVIADA">Enviada</option>
        <option value="COMPLETADA">Completada</option>
      </select>
    </div>
    <div class="filter-group">
      <label>Tipo</label>
      <select id="filterType" class="form-input">
        <option value="">Todos</option>
        <option value="agendar especialista">Especialista</option>
        <option value="agendar medicina general">Medicina General</option>
        <option value="agendar laboratorio">Laboratorio</option>
        <option value="agendar examen">Examen</option>
      </select>
    </div>
    <div class="filter-group">
      <label>Prioridad</label>
      <select id="filterPriority" class="form-input">
        <option value="">Todas</option>
        <option value="ALTA">Alta</option>
        <option value="MEDIA">Media</option>
        <option value="BAJA">Baja</option>
        <option value="URGENTE">Urgente</option>
      </select>
    </div>
  </div>
</div>

<div class="kanban-board" id="kanban"></div>
<div class="notification" id="notification"></div>

<!-- Modal -->
<div id="taskFormModal" class="modal hidden">
  <div class="modal-content">
    <h3 id="formTitle">Nueva Tarea</h3>
    <form id="taskForm">
      <input type="hidden" id="taskId" />

      <!-- Selección paciente -->
      <div class="form-group">
        <label for="tipoPaciente">Agendar cita para:</label>
        <select id="tipoPaciente" class="form-input" onchange="mostrarSecciones()">
          <option value="">Seleccione</option>
          <option value="cotizante">Cotizante</option>
          <option value="beneficiario">Beneficiario</option>
        </select>
      </div>

      <!-- Cotizante -->
      <div id="seccionCotizante" style="display:none;">
        <div class="form-group">
          <label>Nombre completo:</label>
          <div style="display:flex;gap:5px;">
            <input type="text" id="nombreCotizanteBuscar" class="form-input">
            <button type="button" class="btn btn-primary" onclick="buscarCotizante()">Buscar</button>
          </div>
        </div>
        <div class="form-group"><label>Tipo Identificación:</label><input type="text" id="tipoIdentificacionCotizante" class="form-input"></div>
        <div class="form-group"><label>Número Identificación:</label><input type="text" id="numeroIdentificacionCotizante" class="form-input"></div>
        <div class="form-group"><label>EPS:</label><input type="text" id="epsCotizante" class="form-input"></div>
        <div class="form-group"><label>Celular:</label><input type="text" id="celularCotizante" class="form-input"></div>
      </div>

      <!-- Beneficiario -->
      <div id="seccionBeneficiario" style="display:none;">
        <div class="form-group">
          <label>Nombre Beneficiario:</label>
          <div style="display:flex;gap:5px;">
            <input type="text" id="nombreBeneficiarioBuscar" class="form-input">
            <button type="button" class="btn btn-primary" onclick="buscarBeneficiario()">Buscar</button>
          </div>
        </div>
        <div class="form-group"><label>Cotizante Asociado:</label><input type="text" id="nombreCotizanteBeneficiario" class="form-input" readonly></div>
        <div class="form-group"><label>Número Identificación Beneficiario:</label><input type="text" id="numeroIdentificacionBeneficiario" class="form-input"></div>
        <div class="form-group"><label>EPS:</label><input type="text" id="epsBeneficiario" class="form-input"></div>
        <div class="form-group"><label>Celular:</label><input type="text" id="celularBeneficiario" class="form-input"></div>
      </div>

      <!-- Datos Tarea -->
      <div id="seccionDatosTarea" style="display:none;">
        <div class="form-group"><label>Tipo Tarea:</label>
          <select id="tipoTarea" class="form-input">
            <option value="">Seleccione</option>
            <option value="agendar especialista">Especialista</option>
            <option value="agendar medicina general">Medicina General</option>
            <option value="agendar laboratorio">Laboratorio</option>
            <option value="agendar examen">Examen</option>
          </select>
        </div>
        <div class="form-group"><label>Prioridad:</label>
          <select id="prioridad" class="form-input">
            <option value="ALTA">Alta</option>
            <option value="MEDIA" selected>Media</option>
            <option value="BAJA">Baja</option>
            <option value="URGENTE">Urgente</option>
          </select>
        </div>
        <div class="form-group"><label>Fecha Cita:</label><input type="datetime-local" id="fechaCita" class="form-input" onchange="actualizarRecordatorio()"></div>
        <div class="form-group"><label>Doctor:</label><input type="text" id="doctorAtiende" class="form-input"></div>
        <div class="form-group"><label>Lugar:</label><input type="text" id="lugarCita" class="form-input"></div>
        <div class="form-group"><label>Dirección:</label><input type="text" id="direccionCita" class="form-input"></div>
        <div class="form-group"><label>Recordatorio:</label><input type="datetime-local" id="fechaRecordatorio" class="form-input" readonly></div>
        <div class="form-group"><label>Observaciones:</label><textarea id="observaciones" class="form-input"></textarea></div>
        <div class="form-group"><label>Especificaciones:</label><textarea id="especificacionesCita" class="form-input"></textarea></div>
      </div>

      <div class="form-buttons">
        <button type="submit" class="btn btn-success">Guardar</button>
        <button type="button" class="btn btn-secondary" onclick="closeForm()">Cancelar</button>
      </div>
    </form>
  </div>
</div>

<script>
  const GATEWAY_URL = "http://localhost:8080";
  const API_TASKS_URL = `${GATEWAY_URL}/api/v1/tareas`;
  const API_PACIENTES_URL = `${GATEWAY_URL}/api/v1/pacientes`;
  const token = localStorage.getItem("token");
  let tasks = [];

  const estados = ["PENDIENTE","EN_PROGRESO","CITA_CONFIRMADA","ENVIADA","COMPLETADA"];

  if(!token){ alert("Debes iniciar sesión"); window.location="index.html"; }

  function showNotification(msg,type="success"){
    const n=document.getElementById("notification");
    n.textContent=msg; n.style.background=type==="error"?"#e74c3c":"#2ecc71";
    n.classList.add("show"); setTimeout(()=>n.classList.remove("show"),3000);
  }

  async function fetchTasks(){
    const res=await fetch(API_TASKS_URL,{headers:{Authorization:`Bearer ${token}`}});
    tasks=await res.json(); renderTasks();
  }

  function renderTasks(){
    const kanban=document.getElementById("kanban"); kanban.innerHTML="";
    estados.forEach(e=>{
      const col=document.createElement("div");
      col.className="kanban-column";
      const lista=tasks.filter(t=>t.estado===e);
      col.innerHTML=`<h4>${e} (${lista.length})</h4>`;
      lista.forEach(t=>col.appendChild(createCard(t)));
      kanban.appendChild(col);
    });
  }

  function createCard(t){
    const div=document.createElement("div");
    div.className="task-card";
    div.innerHTML=`
        <b>${t.tipo}</b><br>
        ${t.paciente} - ${t.telefono || ""}<br>
        ${t.fecha} ${t.hora}<br>
        <div class="task-actions">
          <button onclick="sendWhatsApp(${t.id})">📲</button>
          <button onclick="advanceStatus(${t.id})">➡️</button>
          <button onclick="editTask(${t.id})">✏️</button>
          <button onclick="deleteTask(${t.id})">🗑️</button>
        </div>`;
    return div;
  }

  function mostrarSecciones(){
    const tipo=document.getElementById("tipoPaciente").value;
    document.getElementById("seccionCotizante").style.display=tipo==="cotizante"?"block":"none";
    document.getElementById("seccionBeneficiario").style.display=tipo==="beneficiario"?"block":"none";
    document.getElementById("seccionDatosTarea").style.display=tipo!==""?"block":"none";
  }

  async function buscarCotizante(){
    const nombre=document.getElementById("nombreCotizanteBuscar").value;
    const res=await fetch(`${API_PACIENTES_URL}/cotizante?nombre=${encodeURIComponent(nombre)}`,{headers:{Authorization:`Bearer ${token}`}});
    const data=await res.json();
    const c=Array.isArray(data)?data[0]:data;
    if(!c) return showNotification("Cotizante no encontrado","error");
    document.getElementById("tipoIdentificacionCotizante").value=c.tipo_identificacion||"";
    document.getElementById("numeroIdentificacionCotizante").value=c.numero_identificacion||"";
    document.getElementById("epsCotizante").value=c.eps||"";
    document.getElementById("celularCotizante").value=c.celular||"";
  }

  async function buscarBeneficiario(){
    const nombre=document.getElementById("nombreBeneficiarioBuscar").value;
    const res=await fetch(`${API_PACIENTES_URL}/beneficiario?nombre=${encodeURIComponent(nombre)}`,{headers:{Authorization:`Bearer ${token}`}});
    const data=await res.json();
    const b=Array.isArray(data)?data[0]:data;
    if(!b) return showNotification("Beneficiario no encontrado","error");
    document.getElementById("nombreCotizanteBeneficiario").value=b.cotizante_nombre||"";
    document.getElementById("numeroIdentificacionBeneficiario").value=b.numero_identificacion||"";
    document.getElementById("epsBeneficiario").value=b.eps||"";
    document.getElementById("celularBeneficiario").value=b.celular||"";
  }

  function actualizarRecordatorio(){
    const fecha=document.getElementById("fechaCita").value;
    if(fecha){
      const f=new Date(fecha); f.setDate(f.getDate()-1);
      document.getElementById("fechaRecordatorio").value=f.toISOString().slice(0,16);
    }
  }

  document.getElementById("taskForm").addEventListener("submit",async e=>{
    e.preventDefault();
    const id=document.getElementById("taskId").value;
    const tipo=document.getElementById("tipoPaciente").value;
    const nombre=tipo==="cotizante"?document.getElementById("nombreCotizanteBuscar").value:document.getElementById("nombreBeneficiarioBuscar").value;
    const celular=tipo==="cotizante"?document.getElementById("celularCotizante").value:document.getElementById("celularBeneficiario").value;
    const tarea={
      tipoPaciente:tipo,
      paciente:nombre,
      telefono:celular,
      tipo:document.getElementById("tipoTarea").value,
      prioridad:document.getElementById("prioridad").value,
      fecha:document.getElementById("fechaCita").value.split("T")[0],
      hora:document.getElementById("fechaCita").value.split("T")[1],
      doctor:document.getElementById("doctorAtiende").value,
      ubicacion:document.getElementById("lugarCita").value,
      direccion_cita:document.getElementById("direccionCita").value,
      fecha_recordatorio:document.getElementById("fechaRecordatorio").value,
      observaciones:document.getElementById("observaciones").value,
      especificaciones_cita:document.getElementById("especificacionesCita").value
    };
    const url=id?`${API_TASKS_URL}/${id}`:API_TASKS_URL;
    const method=id?"PUT":"POST";
    const res=await fetch(url,{method,headers:{"Content-Type":"application/json",Authorization:`Bearer ${token}`},body:JSON.stringify(tarea)});
    if(res.ok){ fetchTasks(); closeForm(); showNotification("Guardado correctamente"); }
    else showNotification("Error al guardar","error");
  });

  function closeForm(){ document.getElementById("taskFormModal").classList.add("hidden"); document.getElementById("taskForm").reset(); }

  function showCreateForm(task=null){
    document.getElementById("formTitle").textContent=task?"Editar Tarea":"Nueva Tarea";
    document.getElementById("taskId").value=task?task.id:"";
    document.getElementById("taskFormModal").classList.remove("hidden");
    if(task){
      document.getElementById("tipoPaciente").value=task.tipoPaciente;
      mostrarSecciones();
      document.getElementById("tipoTarea").value=task.tipo;
      document.getElementById("prioridad").value=task.prioridad;
      document.getElementById("fechaCita").value=`${task.fecha}T${task.hora}`;
      document.getElementById("doctorAtiende").value=task.doctor;
      document.getElementById("lugarCita").value=task.ubicacion;
      document.getElementById("direccionCita").value=task.direccion_cita||"";
      document.getElementById("observaciones").value=task.observaciones||"";
      document.getElementById("especificacionesCita").value=task.especificaciones_cita||"";
      actualizarRecordatorio();
    }
  }

  async function deleteTask(id){
    if(!confirm("¿Eliminar tarea?")) return;
    const res=await fetch(`${API_TASKS_URL}/${id}`,{method:"DELETE",headers:{Authorization:`Bearer ${token}`}});
    if(res.ok){fetchTasks();showNotification("Tarea eliminada");} else showNotification("Error al eliminar","error");
  }

  async function advanceStatus(id){
    const task=tasks.find(t=>t.id===id);
    const nextIndex=estados.indexOf(task.estado)+1;
    if(nextIndex>=estados.length) return showNotification("Ya está completada","error");
    task.estado=estados[nextIndex];
    await fetch(`${API_TASKS_URL}/${id}`,{method:"PUT",headers:{"Content-Type":"application/json",Authorization:`Bearer ${token}`},body:JSON.stringify(task)});
    fetchTasks();
  }

  function sendWhatsApp(id){
    const t=tasks.find(tt=>tt.id===id);
    const msg=`La cita de *${t.paciente}* para *${t.tipo}* fue asignada para el día ${t.fecha} a las ${t.hora} con el DR. ${t.doctor} en ${t.ubicacion}. Recuerde llegar 30 minutos antes.`;
    const url=`https://wa.me/57${t.telefono}?text=${encodeURIComponent(msg)}`;
    window.open(url,"_blank");
  }

  function logout(){ localStorage.removeItem("token"); window.location="index.html"; }

  fetchTasks();
</script>
</body>
</html>
