<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Serviconli - Gesti√≥n de Tareas M√©dicas</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
<div class="header">
    <div class="logo">
        <div class="logo-icon"></div>
        <div class="logo-text">serviconli</div>
    </div>
    <div class="user-info">
        <span>Central de citas - Serviconli</span>
        <div class="user-avatar">cc</div>
    </div>
</div>

<div class="controls">
    <div class="filters">
        <div class="filter-group">
            <label>Estado</label>
            <select class="filter-select" id="filterStatus">
                <option value="">Todos</option>
                <option value="pendiente">Pendientes</option>
                <option value="progreso">En Progreso</option>
                <option value="confirmada">Cita Confirmada</option>
                <option value="completada">Completadas</option>
                <option value="enviada">Enviadas</option>
            </select>
        </div>
        <div class="filter-group">
            <label>Tipo</label>
            <select class="filter-select" id="filterType">
                <option value="">Todos</option>
                <option value="consulta">Agendar Consulta</option>
                <option value="examen">Agendar Examen</option>
                <option value="procedimiento">Agendar Procedimiento</option>
                <option value="especialista">Agendar especialista </option>
            </select>
        </div>
        <div class="filter-group">
            <label>Prioridad</label>
            <select class="filter-select" id="filterPriority">
                <option value="">Todas</option>
                <option value="alta">Alta</option>
                <option value="media">Media</option>
                <option value="baja">Baja</option>
            </select>
        </div>
    </div>
    <div class="action-buttons">
        <button class="btn btn-secondary" onclick="generateReport()">
            üìä Generar Reporte
        </button>
        <button class="btn btn-primary" onclick="openNewTaskModal()">
            + Nueva Tarea
        </button>
    </div>
</div>

<div class="kanban-board">
    <div class="kanban-column" data-status="pendiente">
        <div class="column-header">
            <div class="column-title">
                üìã Pendientes
                <span class="column-count" id="count-pendiente">0</span>
            </div>
        </div>
        <div class="column-content" id="column-pendiente">
            <div class="empty-state">No hay tareas en esta columna</div>
        </div>
    </div>

    <div class="kanban-column" data-status="progreso">
        <div class="column-header">
            <div class="column-title">
                ‚è≥ En Progreso
                <span class="column-count" id="count-progreso">0</span>
            </div>
        </div>
        <div class="column-content" id="column-progreso">
            <div class="empty-state">No hay tareas en esta columna</div>
        </div>
    </div>

    <div class="kanban-column" data-status="confirmada">
        <div class="column-header">
            <div class="column-title">
                ‚úÖ Cita Confirmada
                <span class="column-count" id="count-confirmada">0</span>
            </div>
        </div>
        <div class="column-content" id="column-confirmada">
            <div class="empty-state">No hay tareas en esta columna</div>
        </div>
    </div>

    <div class="kanban-column" data-status="completada">
        <div class="column-header">
            <div class="column-title">
                ‚úÖ Completadas
                <span class="column-count" id="count-completada">0</span>
            </div>
        </div>
        <div class="column-content" id="column-completada">
            <div class="empty-state">No hay tareas en esta columna</div>
        </div>
    </div>

    <div class="kanban-column" data-status="enviada">
        <div class="column-header">
            <div class="column-title">
                üì§ Enviadas
                <span class="column-count" id="count-enviada">0</span>
            </div>
        </div>
        <div class="column-content" id="column-enviada">
            <div class="empty-state">No hay tareas en esta columna</div>
        </div>
    </div>
</div>

<div class="modal" id="taskModal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title" id="modalTitle">Nueva Tarea M√©dica</h3>
            <button class="modal-close" onclick="closeModal()">&times;</button>
        </div>
        <div class="modal-body">
            <form id="taskForm">
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Tipo de Tarea *</label>
                        <select class="form-input" id="taskType" required>
                            <option value="">Seleccionar tipo</option>
                            <option value="consulta">Consulta</option>
                            <option value="examen">Examen</option>
                            <option value="procedimiento">Procedimiento</option>
                            <option value="cirugia">Cirug√≠a</option>
                            <option value="especialista">Especialista</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Prioridad *</label>
                        <select class="form-input" id="taskPriority" required>
                            <option value="">Seleccionar prioridad</option>
                            <option value="alta">Alta</option>
                            <option value="media">Media</option>
                            <option value="baja">Baja</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Cliente *</label>
                    <input type="text" class="form-input" id="taskPatient" required placeholder="Nombre del cliente">
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">EPS</label>
                        <input type="text" class="form-input" id="taskEPS" placeholder="EPS del cliente">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Tel√©fono</label>
                        <input type="tel" class="form-input" id="taskPhone" placeholder="N√∫mero de contacto">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Doctor</label>
                        <input type="text" class="form-input" id="taskDoctor" placeholder="Nombre del doctor">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Lugar de la Cita</label>
                        <input type="text" class="form-input" id="taskLocation" placeholder="Ubicaci√≥n de la cita">
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Observaciones</label>
                    <textarea class="form-input" id="taskObservations" rows="3" placeholder="Observaciones adicionales"></textarea>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Fecha de la Cita</label>
                        <input type="date" class="form-input" id="taskDate">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Hora de la Cita</label>
                        <input type="time" class="form-input" id="taskTime">
                    </div>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeModal()">Cancelar</button>
            <button class="btn btn-primary" onclick="saveTask()">Guardar Tarea</button>
        </div>
    </div>
</div>

<div class="notification" id="notification"></div>

<script>
    let tasks = [];
    let currentEditId = null;

    // Define the order of statuses for progression
    const statusOrder = ['pendiente', 'progreso', 'confirmada', 'completada', 'enviada'];

    // Datos de ejemplo
    const sampleTasks = [
        {
            id: 1,
            type: 'consulta',
            patient: 'Juan P√©rez',
            priority: 'alta',
            eps: 'Sura',
            phone: '3001234567',
            observations: 'Revisi√≥n de control mensual',
            status: 'pendiente',
            date: '2025-07-18',
            time: '10:00',
            doctor: 'Dr. Ana Torres',
            location: 'Cl√≠nica Central',
            created: new Date()
        },
        {
            id: 2,
            type: 'examen',
            patient: 'Mar√≠a Garc√≠a',
            priority: 'media',
            eps: 'Compensar',
            phone: '3009876543',
            observations: 'Examen de sangre rutinario',
            status: 'progreso',
            date: '2025-07-19',
            time: '14:30',
            doctor: 'Dra. Laura V√©lez',
            location: 'Laboratorio Vida',
            created: new Date()
        },
        {
            id: 3,
            type: 'procedimiento',
            patient: 'Carlos Rodr√≠guez',
            priority: 'alta',
            eps: 'Nueva EPS',
            phone: '3005551234',
            observations: 'Biopsia programada',
            status: 'confirmada',
            date: '2025-07-20',
            time: '09:00',
            doctor: 'Dr. Ricardo Gaviria',
            location: 'Hospital La Fe',
            created: new Date()
        },
        {
            id: 4,
            type: 'especialista',
            patient: 'Ana Lopez',
            priority: 'baja',
            eps: 'Sanitas',
            phone: '3001112233',
            observations: 'Cita con cardi√≥logo',
            status: 'pendiente',
            date: '2025-07-25',
            time: '11:00',
            doctor: 'Dr. Felipe Cort√©s',
            location: 'Consultorio CIMA',
            created: new Date()
        }
    ];

    tasks = [...sampleTasks];

    function init() {
        renderTasks();
        setupEventListeners();
        updateCounts();
    }

    function setupEventListeners() {
        // Filtros
        document.getElementById('filterStatus').addEventListener('change', applyFilters);
        document.getElementById('filterType').addEventListener('change', applyFilters);
        document.getElementById('filterPriority').addEventListener('change', applyFilters);
    }

    function createTaskCard(task) {
        const card = document.createElement('div');
        card.className = 'task-card';
        card.dataset.taskId = task.id;

        card.innerHTML = `
                <div class="task-header">
                    <span class="task-type ${task.type}">${task.type.charAt(0).toUpperCase() + task.type.slice(1)}</span>
                    <span class="task-priority priority-${task.priority}">${task.priority.charAt(0).toUpperCase() + task.priority.slice(1)}</span>
                </div>
                <div class="task-patient">${task.patient}</div>
                <div class="task-details">
                    <div class="task-detail">üì± ${task.phone || 'No especificado'}</div>
                    <div class="task-detail">üè• ${task.eps || 'No especificado'}</div>
                    ${task.doctor ? `<div class="task-detail">üë®‚Äç‚öïÔ∏è ${task.doctor}</div>` : ''}
                    ${task.location ? `<div class="task-detail">üìç ${task.location}</div>` : ''}
                    ${task.date ? `<div class="task-detail">üìÖ ${task.date} ${task.time || ''}</div>` : ''}
                </div>
                <div class="task-actions">
                    <button class="task-action whatsapp" onclick="sendWhatsApp(${task.id})">WhatsApp</button>
                    <button class="task-action edit" onclick="editTask(${task.id})">Editar</button>
                    <button class="task-action notes" onclick="addNotes(${task.id})">Notas</button>
                    <button class="task-action next-stage" onclick="moveToNextStage(${task.id})">Siguiente Etapa</button>
                </div>
            `;

        return card;
    }

    function renderTasks() {
        const columns = ['pendiente', 'progreso', 'confirmada', 'completada', 'enviada'];

        columns.forEach(status => {
            const column = document.getElementById(`column-${status}`);
            const filteredTasks = getFilteredTasks().filter(task => task.status === status);

            column.innerHTML = '';

            if (filteredTasks.length === 0) {
                column.innerHTML = '<div class="empty-state">No hay tareas en esta columna</div>';
            } else {
                filteredTasks.forEach(task => {
                    column.appendChild(createTaskCard(task));
                });
            }
        });

        updateCounts();
    }

    function getFilteredTasks() {
        const statusFilter = document.getElementById('filterStatus').value;
        const typeFilter = document.getElementById('filterType').value;
        const priorityFilter = document.getElementById('filterPriority').value;

        return tasks.filter(task => {
            return (!statusFilter || task.status === statusFilter) &&
                (!typeFilter || task.type === typeFilter) &&
                (!priorityFilter || task.priority === priorityFilter);
        });
    }

    function updateCounts() {
        const columns = ['pendiente', 'progreso', 'confirmada', 'completada', 'enviada'];
        const filteredTasks = getFilteredTasks();

        columns.forEach(status => {
            const count = filteredTasks.filter(task => task.status === status).length;
            document.getElementById(`count-${status}`).textContent = count;
        });
    }

    function applyFilters() {
        renderTasks();
    }

    function openNewTaskModal() {
        currentEditId = null;
        document.getElementById('modalTitle').textContent = 'Nueva Tarea M√©dica';
        document.getElementById('taskForm').reset();
        document.getElementById('taskModal').classList.add('active');
    }

    function editTask(id) {
        const task = tasks.find(t => t.id === id);
        if (!task) return;

        currentEditId = id;
        document.getElementById('modalTitle').textContent = 'Editar Tarea';

        document.getElementById('taskType').value = task.type;
        document.getElementById('taskPriority').value = task.priority;
        document.getElementById('taskPatient').value = task.patient;
        document.getElementById('taskEPS').value = task.eps || '';
        document.getElementById('taskPhone').value = task.phone || '';
        document.getElementById('taskDoctor').value = task.doctor || ''; /* New field */
        document.getElementById('taskLocation').value = task.location || ''; /* New field */
        document.getElementById('taskObservations').value = task.observations || '';
        document.getElementById('taskDate').value = task.date || '';
        document.getElementById('taskTime').value = task.time || '';

        document.getElementById('taskModal').classList.add('active');
    }

    function closeModal() {
        document.getElementById('taskModal').classList.remove('active');
        currentEditId = null;
    }

    function saveTask() {
        const form = document.getElementById('taskForm');
        if (!form.checkValidity()) {
            form.reportValidity();
            return;
        }

        const taskData = {
            type: document.getElementById('taskType').value,
            priority: document.getElementById('taskPriority').value,
            patient: document.getElementById('taskPatient').value,
            eps: document.getElementById('taskEPS').value,
            phone: document.getElementById('taskPhone').value,
            doctor: document.getElementById('taskDoctor').value, /* New field */
            location: document.getElementById('taskLocation').value, /* New field */
            observations: document.getElementById('taskObservations').value,
            date: document.getElementById('taskDate').value,
            time: document.getElementById('taskTime').value
        };

        if (currentEditId) {
            // Editar tarea existente
            const taskIndex = tasks.findIndex(t => t.id === currentEditId);
            if (taskIndex !== -1) {
                tasks[taskIndex] = { ...tasks[taskIndex], ...taskData };
                showNotification('Tarea actualizada exitosamente');
            }
        } else {
            // Crear nueva tarea
            const newTask = {
                id: Date.now(),
                ...taskData,
                status: 'pendiente', // New tasks start as 'pendiente'
                created: new Date()
            };
            tasks.push(newTask);
            showNotification('Tarea creada exitosamente');
        }

        renderTasks();
        closeModal();
    }

    function moveToNextStage(taskId) {
        const task = tasks.find(t => t.id === taskId);
        if (task) {
            const currentIndex = statusOrder.indexOf(task.status);
            if (currentIndex < statusOrder.length - 1) {
                task.status = statusOrder[currentIndex + 1];
                showNotification(`Tarea de "${task.patient}" movida a "${task.status.charAt(0).toUpperCase() + task.status.slice(1)}."`);
                renderTasks();
            } else {
                showNotification('La tarea ya est√° en la √∫ltima etapa.', 'error');
            }
        }
    }

    function sendWhatsApp(taskId) {
        const task = tasks.find(t => t.id === taskId);
        if (task && task.phone) {
            const message = `Hola se√±or/a ${task.patient},
Le saluda Biviana de la Central de Citas de Serviconli. üåø
Me permito recordarle que tiene una cita programada el d√≠a ${task.date || '[Fecha]'} a las ${task.time || '[Hora]'}, en ${task.location || '[Lugar o sede]'}, con el doctor/a ${task.doctor || '[Nombre del profesional]'}.
En Serviconli estamos comprometidos con su bienestar y el de su familia. Si tiene alguna inquietud, no dude en contactarnos.
¬°Gracias por confiar en nosotros! üíô
‚Äî Equipo Serviconli`;

            const url = `https://wa.me/57${task.phone}?text=${encodeURIComponent(message)}`;
            window.open(url, '_blank');
            showNotification('Mensaje de WhatsApp enviado');
        } else {
            showNotification('No se encontr√≥ n√∫mero de tel√©fono para este cliente', 'error');
        }
    }

    function addNotes(taskId) {
        const task = tasks.find(t => t.id === taskId);
        if (task) {
            const notes = prompt('Agregar notas de observaci√≥n:', task.observations || '');
            if (notes !== null) {
                task.observations = notes;
                renderTasks();
                showNotification('Notas actualizadas');
            }
        }
    }

    function generateReport() {
        const filteredTasks = getFilteredTasks();

        if (filteredTasks.length === 0) {
            showNotification('No hay tareas para generar el reporte', 'error');
            return;
        }

        // Crear CSV
        const csvContent = [
            ['ID', 'Tipo', 'Cliente', 'Prioridad', 'EPS', 'Tel√©fono', 'Doctor', 'Lugar de Cita', 'Estado', 'Fecha Cita', 'Hora Cita', 'Observaciones'],
            ...filteredTasks.map(task => [
                task.id,
                task.type,
                task.patient,
                task.priority,
                task.eps || '',
                task.phone || '',
                task.doctor || '', /* New field in report */
                task.location || '', /* New field in report */
                task.status,
                task.date || '',
                task.time || '',
                task.observations || ''
            ])
        ].map(row => row.join(',')).join('\n');

        // Descargar archivo
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;'});
        const link = document.createElement('a');
        const url = URL.createObjectURL(blob);
        link.setAttribute('href', url);
        link.setAttribute('download', `reporte_tareas_${new Date().toISOString().split('T')[0]}.csv`);
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);

        showNotification('Reporte generado y descargado');
    }

    function showNotification(message, type = 'success') {
        const notification = document.getElementById('notification');
        notification.textContent = message;
        notification.style.background = type === 'error' ? '#ef4444' : '#10b981';
        notification.classList.add('show');

        setTimeout(() => {
            notification.classList.remove('show');
        }, 3000);
    }

    // Simulaci√≥n de recordatorios
    function checkReminders() {
        const now = new Date();

        tasks.forEach(task => {
            // Only remind for 'pendiente' or 'progreso' tasks that have a date and time set
            if (['pendiente', 'progreso'].includes(task.status) && task.date && task.time) {
                const taskDateTime = new Date(`${task.date}T${task.time}`);
                // Trigger reminder 5 minutes before the appointment
                const reminderTime = new Date(taskDateTime.getTime() - 5 * 60 * 1000);

                if (now >= reminderTime && now < taskDateTime) {
                    showNotification(`Recordatorio: ${task.patient} - ${task.type} en 5 minutos (${task.doctor || 'Sin doctor'}) en ${task.location || 'sin ubicaci√≥n'}`, 'warning');
                }
            }
        });
    }

    // Inicializar la aplicaci√≥n
    init();

    // Verificar recordatorios cada minuto
    setInterval(checkReminders, 60000);

    // Cerrar modal con Escape
    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
            closeModal();
        }
    });

    // Cerrar modal al hacer clic fuera
    document.getElementById('taskModal').addEventListener('click', (e) => {
        if (e.target === e.currentTarget) {
            closeModal();
        }
    });
</script>
</body>
</html>